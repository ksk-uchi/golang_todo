[tools]
air = "1.64.4"
atlas = "v1.0.0"
go = "1.25.6"
"go:github.com/google/wire/cmd/wire" = "0.7.0"

[tasks.create-shadow-db]
run = '''
podman compose exec db -- mysql -u root --password=root_password -e "CREATE DATABASE todo_db_dev"
'''

[tasks.drop-shadow-db]
run = '''
podman compose exec db -- mysql -u root --password=root_password -e "DROP DATABASE todo_db_dev"
'''

[tasks.create-migrate]
usage = '''
arg "<migration_file_name>" help="This will be a part of migration file name."
'''
run = '''
# 1. 引数チェック (未指定ならここで即終了し、DB作成も行わない)
if [ -z "$usage_migration_file_name" ]; then
  echo "error: <migration_file_name> is required"
  exit 1
fi

# 2. 後処理 (drop-shadow-db) を登録
# EXIT シグナルを捕捉するため、成功・失敗に関わらずスクリプト終了時に実行される
trap 'mise run drop-shadow-db' EXIT

# 3. 前準備
mise run create-shadow-db

# 4. メイン処理
atlas migrate diff "${usage_migration_file_name}" \
  --dir "file://ent/migrate/migrations" \
  --to "ent://ent/schema" \
  --dev-url "mysql://root:root_password@localhost:3306/todo_db_dev"
'''

[tasks.migrate]
run = '''
atlas migrate apply \
  --dir "file://ent/migrate/migrations" \
  --url "mysql://root:root_password@localhost:3306/todo_db"
'''

[tasks.new-schema]
usage = '''
arg "<name>" help="This will be a struct name."
'''
run = '''
go run -mod=mod entgo.io/ent/cmd/ent new ${usage_name}
'''
