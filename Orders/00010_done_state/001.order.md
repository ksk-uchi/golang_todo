# ToDo を完了・未完了状態に変更する機能の実装

## 背景

- `todos` テーブルには `done_at` というカラムがあるが、ユーザによるデータ更新 `PATCH /todo/:id` の更新対象ではない。
- 完了・未完了状態を切り替える機能を追加する。

## 対応内容

1. (backend, frontend) ToDo の情報に `done_at` を追加する
   - (backend) `backend/dto/todo.go` の `TodoDto` に `DoneAt` を追加する
     - ``time.Time `json:"done_at"` ``
   - (frontend) `GET /todo`, `POST /todo`, `PATCH /todo/:id` のレスポンスが `done_at` を含むようになるので受け取れるように改修する
2. (backend) `PUT /todo/:id/done` エンドポイントを追加する
   - JSON body で `{"is_done": true}` or `{"is_done": false}` を受け取る
   - `is_done` が true の場合は `done_at` に現在時刻を保存する
   - `is_done` が false の場合は `done_at` を null にする
   - トランザクションを作り対象レコードを `SELECT FOR UPDATE` で行ロックする
     - トランザクションはサービス層で作り、管理する
       - サービス層で `client := ent.FromContext(ctx)` とするとクライアントが取得できる
         - ハンドラで `ctx = ent.NewContext(ctx, h.client)` としているため
       - `client.Tx(ctx)` でトランザクションを作り、 `ctx = ent.NewTxContext(ctx, tx)` トランザクションを context に詰める
         - そうすることでリポジトリ層はコンテキストから `tx = ent.TxFromContext(ctx)` でトランザクションを取得し処理がトランザクションの中で実行される
     - 当然 `done_at` 更新後はコミットする
     - `backend/ent/todo_query.go` は現在 `ForUpdate` メソッドを持っているためそれを使って `SELECT FOR UPDATE` を実行する
   - すでに `done_at` が NULL ではないデータに対し `is_done: true` を送った場合は何もしない。
     - `done_at` が NULL のデータに対し `is_done: false` を送った場合も何もしない
   - エンドポイントに対するテストとサービスに対するテストを実装する
3. (backend) `PATCH /todo/:id` エンドポイントを改修する
   - トランザクションを作り対象レコードを `SELECT FOR UPDATE` で行ロックするように修正する
     - トランザクションはサービス層で作り、管理する
   - `done_at` が NULL でない場合は更新を許可しない
     - 400 Bad Request を返す
       - サービス層が `backend/errors/` (ディレクトリを新規作成してください) 配下に作成したカスタムエラーを返却し、`backend/handlers/todo.go` の `UpdateTodo` はカスタムエラーをハンドリングする
   - エンドポイントに対するテストとサービスに対するテストを実装する
4. (frontend) ToDo の完了・未完了状態を切り替える機能を追加する
   - `frontend/src/app/components/TodoItem.tsx` で定義される `<TodoItem>` 内の左端にチェックボックスを追加する
     - チェックボックスをクリックすると `PUT /todo/:id/done` を呼び出す
   - 完了状態の ToDo は文字色を灰色にする
5. (frontend) ToDo 編集用のモーダルを改修する
   - `frontend/src/app/components/TodoModal.tsx` が改修対象
   - 完了状態の ToDo は `title` と `description` をラベルやテキストで表示し、編集できないようにする
     - 一覧表示と違い、文字の色はそのままでよい
   - モーダル内に ToDo を完了にするためのチェックボックスを追加する
     - チェックが入ると `title` と `description` が編集不可能になり、チェックが外れると編集可能になる

## 作業ガイドライン

作業に当たり下記のガイドラインを必ず遵守してください

### backend, frontend 共通

- Implementation Plan, Task, Walkthrough やその他の情報交換は日本語で出力してください
- **対応内容の番号を振った段落ごとにコミットを作成すること**
  - git add するのは対応のために操作したファイルのみにすること。 Orders ディレクトリ等、作業に関係ないファイルは追加しないこと
- 明記されていないエッジケースがある場合、事前に確認を取ってください
  - 検討したうえで order ファイルに追記し、再度作業依頼をします
- 独自に実装するよりも近しい機能を持つ実装がインストール済みのライブラリに存在する場合は、事前に提案してください
  - 検討したうえで order ファイルに追記し、再度作業依頼をします
  - 例: ページネーションを実装してほしいと依頼されていますが MUI の Pagination コンポーネントを使うのはどうでしょうか？

### backend

- 対応後は全テストを実行しデグレードを見逃さないこと

### frontend

- `shadcn` コンポーネントを薄くラップするものは `src/app/components/ui/` 下に配置すること
- `src/app/components/ui` 下のコンポーネントを集めて機能を作るときは `src/app/components/` 下にファイルを作り実装すること
- `src/app/components` 下のコンポーネントを集めてページを作るときは `src/app/` 下にファイルを作り実装すること

## 許可済みコマンド

以下のコマンドは毎回確認を求めずに実行してよい (SafeToAutoRun: true)

- `git status`
- `git add .`
- `git commit -m "..."`
- `git log`
- `ls -R`
- `cat ...`
- `grep ...`
- `go test ...`
- `mise run ...`
