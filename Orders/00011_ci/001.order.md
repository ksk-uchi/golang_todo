# Github Actions を使った CI の実装

## 背景

- `backend/` にはユニットテストがある。また `backend/` `frontend/` とも Lint による検証がある。
  - これらはローカル環境でコミットの際に `lefthook` によって行われたり、開発者が明示的に実行したりするものである
  - `main` ブランチにマージを試みる PR 作成時に CI (Github Actions) でも Lint とユニットテストを実行するようにしたい
  - `backend/` のユニットテストはローカル環境において `go test ./...` で実行するが、SQLite を用いたテストを行うため一部テストをスキップしている箇所がある
  - `SELECT FOR UPDATE` 文を発行し、行ロックを使った排他制御を行っている箇所があるが、SQLite には `SELECT FOR UPDATE` 文が存在しないためスキップしている
  - skip は環境変数 `TEST_WITH_REAL_DB` によって制御されており、この環境変数がセットされていなければととｔととなる
  - ただし、検証はしないとデグレードが発生する可能性が上がってしまう

## 対応内容

1. `backend/.golangci.yml` を作成し、下記のリンターを有効にする
   - errcheck
   - gosimple
   - govet
   - ineffassign
   - staticcheck
   - unused
2. (backend action) `backend/` 下のファイルに変更がある PR 作成時に CI (Github Actions) を実行するようにする
   - `ubuntu-latest` に `mise` を導入し `backend/mise.toml` を用いて環境を作成する
   - 下記の環境変数を設定する
     - APP_ENV = "ci"
   - `backend/` 以下のファイルに変更があった場合は下記を実行する
     - `go fmt ./...`
     - `golangci-lint run`
3. (frontend action) `frontend/` 下のファイルに変更がある PR 作成時に CI (Github Actions) を実行するようにする
   - `ubuntu-latest` に `mise` を導入し `frontend/mise.toml` を用いて環境を作成する
   - `frontend/` 以下のファイルに変更があった場合は下記を実行する
     - `pnpm exec prettier --check .`
     - `pnpm exec eslint .`
4. (backend action) `backend/` で `go test ./...` を実行するために `MySQL` コンテナを起動するようにする
   - `MySQL` コンテナは `backend/docker-compose.yml` で起動する
     - `Github Actions` の `services` で立ち上げるのではなく `docker compose up` でコンテナを起動する
5. (backend action) 2 で作った github actions の workflow に `go test` を追加する
   - `MySQL` コンテナのヘルスチェックが OK になったら `go test ./...` を実行する

## 作業ガイドライン

作業に当たり下記のガイドラインを必ず遵守してください

### backend, frontend 共通

- Implementation Plan, Task, Walkthrough やその他の情報交換は日本語で出力してください
- **対応内容の番号を振った段落ごとにコミットを作成すること**
  - git add するのは対応のために操作したファイルのみにすること。 Orders ディレクトリ等、作業に関係ないファイルは追加しないこと
- 明記されていないエッジケースがある場合、事前に確認を取ってください
  - 検討したうえで order ファイルに追記し、再度作業依頼をします
- 独自に実装するよりも近しい機能を持つ実装がインストール済みのライブラリに存在する場合は、事前に提案してください
  - 検討したうえで order ファイルに追記し、再度作業依頼をします
  - 例: ページネーションを実装してほしいと依頼されていますが MUI の Pagination コンポーネントを使うのはどうでしょうか？

### backend

- 対応後は全テストを実行しデグレードを見逃さないこと

### frontend

- `shadcn` コンポーネントを薄くラップするものは `src/app/components/ui/` 下に配置すること
- `src/app/components/ui` 下のコンポーネントを集めて機能を作るときは `src/app/components/` 下にファイルを作り実装すること
- `src/app/components` 下のコンポーネントを集めてページを作るときは `src/app/` 下にファイルを作り実装すること

## 許可済みコマンド

以下のコマンドは毎回確認を求めずに実行してよい (SafeToAutoRun: true)

- `git status`
- `git add .`
- `git commit -m "..."`
- `git log`
- `ls -R`
- `cat ...`
- `grep ...`
- `go test ...`
- `mise run ...`
