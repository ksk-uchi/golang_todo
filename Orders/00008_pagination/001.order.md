# ToDo 一覧ページにページネーション機能を追加

## 背景・要件

- ToDo 一覧ページにページネーション機能を追加する
  - 1ページあたりの表示件数は 20 件とする
  - ユーザー向けの URL には `page` というクエリパラメータを使用する
    - `?page=1` のようにする
    - API には `limit` というクエリパラメータがあるが、ユーザー向けの URL には表示しない
    - ユーザーはブラウザの戻るボタンで前のページを表示することが出来る
      - 戻るボタンを押した場合は URL に従い `GET /todo` API エンドポイントにリクエストし、その結果を画面に表示する

## 対応内容

1. (backend/frontend) `GET /todo` エンドポイントの既存の返却値を変更する
   - 現在返却している Todo の配列を `data` キーに格納する
   - それに伴うテストの修正を行う
   - それに伴うフロントエンドの修正を行う

2. (backend) `GET /todo` エンドポイントにページネーション情報を追加する
   - 1ページあたりの表示件数は 20 件とする
     - 上限は 100 件とする
   - `GET /todo?page=2&limit=20` のようなクエリパラメータで表示するコンテンツが決定する
     - `limit` は 20 とする
     - `page` は 1 から始まる
   - `GET /todo` の返却値はこの時点ではまだ `data` キーに格納した配列のみだが、同階層に `pagination` キーを追加する
     - `pagination` キーはオブジェクトで、下記のキーを含む
       - `total_pages`: 全ページ数 (int)
       - `current_page`: 現在のページ番号 (int)
       - `has_next`: 次のページがあるか (bool)
       - `has_prev`: 前のページがあるか (bool)
       - `limit`: 1 ページあたりの表示件数 (int)
   - `backend/repositories/todo.go` の `FetchAllTodos` を `FetchTodos` に修正してページネーションに対応させる
     - データのソートは `updated_at` の降順、 `id` の降順とする
     - `FetchTodos` は `offset` と `limit` を引数に取り、 `[]Todo` と `error` を返す
   - `backend/repositories/todo.go` に `GetTodoCount` を追加する
     - `GetTodoCount` は `int` と `error` を返す
   - `backend/dto/todo.go` に構造体を追加する
     - `PaginationDto` 構造体
       - `total_pages`: 全ページ数 (int)
       - `current_page`: 現在のページ番号 (int)
       - `has_next`: 次のページがあるか (bool)
       - `has_prev`: 前のページがあるか (bool)
       - `limit`: 1 ページあたりの表示件数 (int)
     - `ListTodoResponseDto` 構造体
       - `data`: `[]*dto.TodoDto`
       - `pagination`: `*dto.PaginationDto`
   - `backend/services/todo.go` の `GetTodoSlice` を修正し `current_page` と `limit` を引数に取り、 `[]*dto.TodoDto` と `error` を返す
     - リポジトリのインターフェース定義が変更になるので修正する
     - `current_page` と `limit` から `offset` を計算し、リポジトリの `FetchTodos` を呼び出す
       - `current_page` が 4 で `limit` が 20 の場合、 `offset` は 60 になる
   - `backend/services/todo.go` に `CalculatePagination` を追加する
     - `CalculatePagination` は `current_page` と `limit` を引数に取り、 `*dto.PaginationDto` を返す
     - `GetTodoCount` を呼び出し、ToDo の総件数と `limit` から `total_pages` を計算する
     - `current_page` が 1 の場合は `has_prev` を `false` にする
     - `current_page` が `total_pages` の場合は `has_next` を `false` にする
   - `backend/handlers/todo.go` の `ListTodo` は `ListTodoResponseDto` を返すようにする
     - `ListTodo` は URL のパラメータ `page` と `limit` を使って `GetTodoSlice` を呼び出す
     - `ListTodo` は URL のパラメータ `page` と `limit` を使って `CalculatePagination` を呼び出す
     - `GetTodoSlice` から返却された `[]*dto.TodoDto` と `CalculatePagination` から返却された `*dto.PaginationDto` を `dto.ListTodoResponseDto` に格納し、 `dto.ListTodoResponseDto` を返す
   - 既存テストの修正
   - ページネーションに関する新規テストの追加
     - 1 ページ目
     - 最終ページ
     - 中間のページ
     - limit, page を変更した場合
3. (frontend) ToDo 一覧ページにページネーション機能を追加する
   - ページネーションは `shadcn` コンポーネントを使用する
     - `shadcn` の `Pagination` コンポーネントは `frontend/src/app/components/ui/pagination.tsx` に格納済み
   - ページネーションの表示は下記のようになる (表示件数 20 件、全 5 ページの場合)
     - [< Previous(非活性)] [**1**] [2] [3] [...(PaginationEllipsis)] [Next >]
     - [< Previous(活性)] [1] [**2**] [3] [...(PaginationEllipsis)] [Next >]
     - [< Previous] [...(PaginationEllipsis)] [2] [**3**] [4] [...(PaginationEllipsis)] [Next >]
     - [< Previous] [...(PaginationEllipsis)] [3] [**4**] [5] [Next >]
     - [< Previous] [...(PaginationEllipsis)] [3] [4] [**5**] [Next(非活性)]
   - 現在表示しているページで ToDo の増減が発生した場合、 `GET /todo` の再実行は行わない
     - ToDo を一件増やした場合、現在開いているページの先頭に追加した ToDo が表示されるようにする
       - UX 上の下記の懸念は許容する
         - ページをリロードした場合先頭に追加した ToDo は消えてしまう
         - 例えば 4 ページ目で ToDo を追加し、ブラウザの戻るボタンで 3 ページ目を表示した際、追加前に 3 ページ目の下部に表示されていた ToDo は表示されない (4 ページ目に移動となるため)
         - 次のページに移動した場合に先程開いていたページの下部に表示されていた ToDo が表示される
         - 上記のようにすることでユーザーは作成したての ToDo をすぐに確認・編集・削除することが出来る
     - ToDo を一件削除した場合、現在開いているページの ToDo を一件減らす
       - 現在 20 件表示されている場合は 19 件表示されている状態になる
       - 現在 1 件表示されている場合は前のページに移動する
         - 現在 1 ページ目で最後の 1 件を削除した場合はそのまま 1 ページ目を表示する
   - ページを移動した場合やリロードが発生した場合は再度 `GET /todo?page=...&limit=20` を実行する
     - その際、増減した ToDo の考慮は行わず、 API の返却したデータを表示する

## 作業ガイドライン

作業に当たり下記のガイドラインを必ず遵守してください

### backend, frontend 共通

- Implementation Plan, Task, Walkthrough やその他の情報交換は日本語で出力してください
- **対応内容の番号を振った段落ごとにコミットを作成すること**
- 明記されていないエッジケースがある場合、事前に確認を取ってください
  - 検討したうえで order ファイルに追記し、再度作業依頼をします
- 独自に実装するよりも近しい機能を持つ実装がインストール済みのライブラリに存在する場合は、事前に提案してください
  - 検討したうえで order ファイルに追記し、再度作業依頼をします
  - 例: ページネーションを実装してほしいと依頼されていますが MUI の Pagination コンポーネントを使うのはどうでしょうか？

### backend

- 対応後は全テストを実行しデグレードを見逃さないこと

### frontend

- `shadcn` コンポーネントを薄くラップするものは `src/app/components/ui/` 下に配置すること
- `src/app/components/ui` 下のコンポーネントを集めて機能を作るときは `src/app/components/` 下にファイルを作り実装すること
- `src/app/components` 下のコンポーネントを集めてページを作るときは `src/app/` 下にファイルを作り実装すること

## 許可済みコマンド

以下のコマンドは毎回確認を求めずに実行してよい (SafeToAutoRun: true)

- `git status`
- `git add .`
- `git commit -m "..."`
- `git log`
- `ls -R`
- `cat ...`
- `grep ...`
- `go test ...`
- `mise run ...`
