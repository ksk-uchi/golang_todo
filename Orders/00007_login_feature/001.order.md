# ユーザーのログイン機能作成

## 背景

- users テーブルを作成した
  - users テーブルには１レコードのみ存在する

## 対応内容

1. (backend) ログイン用の API を作成する
   - ログイン用の API は `POST /auth/login` に作成する
   - API は `email` と `password` をリクエストボディ (JSON) で受け取る
   - API は users テーブルのレコードと照合して認証を行う
     - `password` は bcrypt で暗号化されているため `golang.org/x/crypto/bcrypt` パッケージの `CompareHashAndPassword` 関数を使用して照合する
   - 認証に成功した場合は、JWT トークンを生成して Cookie に格納する
     - JWT トークンは `github.com/golang-jwt/jwt/v5` パッケージを使用して生成する
     - JWT トークンは `HS256` アルゴリズムで生成する
     - JWT トークンには `exp` クレームを含める(1時間後)
     - Cookie は `SameSite=Strict`、`HttpOnly` を設定する
2. (backend) 環境変数を追加する
   - mise.toml の `[env]` セクションに `APP_ENV` を追加し、値を `local` とする
   - `.env.local.sample` を `envs/local.env.sample` に移動・リネームする
   - `envs/local.env.sample` ををコピーして `envs/local.env` を作成する
     - `envs/local.env` は .gitignore に追加する
   - アプリケーション起動時 `server.go` の main 関数で環境変数を読み込むようにする
     - 環境変数を扱うために `joho/godotenv` の `Load` 関数を使う
       - まず `APP_ENV` を読み込む
       - 次に `envs/${APP_ENV}.env` を読み込む
3. (backend) ログイン用以外の URL に認証ミドルウェアを追加する
   - 秘密鍵は `envs/local.env` に `JWT_SECRET` として定義する
     - 秘密鍵は `envs/local.env.sample` にも同じ値を `JWT_SECRET` として定義する
   - 認証情報の JWT トークンは Cookie に格納されている
   - 認証ミドルウェアは下記のように実装する
     - JWT トークンは `github.com/golang-jwt/jwt/v5` パッケージを使用して解析する
     - JWT トークンが有効でない場合は、401 Unauthorized エラーを返す
     - JWT トークンが有効な場合は、次に処理を進める
     - 秘密鍵は環境変数 (`os.Getenv("JWT_SECRET")`) から取得する
   - 認証後、ユーザー情報 (`*ent.User`) はコンテキストに格納する
   - Cookie と JWT トークンの有効期限を更新する
     - 有効期限を更新した JWT トークンを生成して `Set-Cookie` ヘッダーに追加する
4. (backend) 既存 API 実装の修正
   - 各種リポジトリはコンテキストからユーザー情報を取得して使用する
     - `CreateTodo`: todo データを作成する際、コンテキストからユーザー情報を取得し、ユーザーに紐づくようにする
     - `ListTodo`: todo データを取得する際、コンテキストからユーザー情報を取得し、ユーザーに紐づく todo データのみを返却する
     - `UpdateTodo`: todo データを更新する際、コンテキストからユーザー情報を取得し、ユーザーに紐づく todo データのみを更新する
     - `DeleteTodo`: todo データを削除する際、コンテキストからユーザー情報を取得し、ユーザーに紐づく todo データのみを削除する
     - ほかユーザーの todo データを更新・削除しようとした場合は、404 Not Found エラーを返す
       - リポジトリ層の実装で WHERE 句にユーザー情報が入るため、対象のデータが存在しないため Not Found と同じ動作になるはず
   - 既存のハンドラのテストを修正する
     - Cookie が含まれていない場合は、401 Unauthorized エラーを返す
     - 既存のテスト実装の Cookie をセットする
5. (frontend) ログイン画面を作成する
   - ログイン画面は `src/app/login/page.tsx` に作成する
   - ログイン画面は `email` と `password` を入力するフォームで構成する
   - ログイン画面は `POST /auth/login` にリクエストを送る
   - ログインが成功したら
     - (サーバーからの Set-Cookie により JWT トークンが Cookie に保存される)
     - `/` にリダイレクトする
6. (frontend) API にリクエストを送信した際、 401 Unauthorized エラーが返ってきた場合はログイン画面にリダイレクトする
   - `axios` のインスタンス作成時に `withCredentials: true` を設定する

## 作業ガイドライン

作業に当たり下記のガイドラインを必ず遵守してください

### backend, frontend 共通

- Implementation Plan, Task, Walkthrough やその他の情報交換は日本語で出力してください
- **対応内容の番号を振った段落ごとにコミットを作成すること**
- 明記されていないエッジケースがある場合、事前に確認を取ってください
  - 検討したうえで order ファイルに追記し、再度作業依頼をします
- 独自に実装するよりも近しい機能を持つ実装がインストール済みのライブラリに存在する場合は、事前に提案してください
  - 検討したうえで order ファイルに追記し、再度作業依頼をします
  - 例: ページネーションを実装してほしいと依頼されていますが MUI の Pagination コンポーネントを使うのはどうでしょうか？

### backend

- 対応後は全テストを実行しデグレードを見逃さないこと

### frontend

- `shadcn` コンポーネントを薄くラップするものは `src/app/components/ui/` 下に配置すること
- `src/app/components/ui` 下のコンポーネントを集めて機能を作るときは `src/app/components/` 下にファイルを作り実装すること
- `src/app/components` 下のコンポーネントを集めてページを作るときは `src/app/` 下にファイルを作り実装すること

## 許可済みコマンド

以下のコマンドは毎回確認を求めずに実行してよい (SafeToAutoRun: true)

- `git status`
- `git add .`
- `git commit -m "..."`
- `git log`
- `ls -R`
- `cat ...`
- `grep ...`
- `go test ...`
- `mise run ...`
